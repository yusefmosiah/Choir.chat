# Deep Linking Vector and Web Search Results

## Overview

This document outlines the plan to enable deep linking of vector search results to threads, and inline linking of web search results, within the Choir PostChain workflow.

---

## Goals

- **Persist** the user's query vector along with its `thread_id` metadata.
- **Return** vector search results with their associated `thread_id` metadata.
- **Allow the frontend** to generate deep links for vector results belonging to local threads.
- **Return** web search results with URLs for inline clickable links.
- **Keep backend logic simple**: no URL generation or link flagging.

---

## Backend Implementation Plan

### 1. Pass `thread_id` into `run_experience_vectors_phase`

- Update the function signature:

```python
async def run_experience_vectors_phase(
    messages: List[BaseMessage],
    model_config: ModelConfig,
    thread_id: Optional[str] = None
) -> ExperienceVectorsPhaseOutput:
```

- Update all calls to this function (notably in `run_langchain_postchain_workflow`) to pass the thread ID.

---

### 2. Save `thread_id` when storing the query vector

- When saving the embedded query vector, include:

```python
metadata = {
    "role": "user_query",
    "phase": "experience_vectors",
    "thread_id": thread_id  # only if thread_id is not None
}
```

- This associates the saved vector with the originating thread.

---

### 3. Include thread IDs in vector search results

- The Qdrant vector metadata will include `"thread_id"` if saved as above.
- When parsing search results, preserve this metadata so the frontend can identify thread ownership.
- **No** deep link URLs or flags are generated by the backend.

---

### 4. Web search results

- Already include URLs in their metadata or content.
- The frontend will render them as clickable links.

---

## Frontend Responsibilities

- **For vector results:**
  - If `thread_id` matches a local thread, generate a deep link (e.g., `choir://thread/{thread_id}`).
  - Otherwise, display as plain text or non-clickable content.

- **For web results:**
  - Render URLs as clickable links.

---

## Sequence Diagram

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant Backend
    participant QdrantDB

    User->>Frontend: Sends query in thread X
    Frontend->>Backend: Calls workflow(query, thread_id=X)

    Backend->>Backend: Embed query -> query_vector
    Backend->>QdrantDB: Save query_vector with metadata {thread_id: X}
    QdrantDB-->>Backend: Save success

    Backend->>QdrantDB: Search similar vectors
    QdrantDB-->>Backend: Results with metadata (may include thread_id)

    Backend->>Frontend: Returns vector_results with metadata (thread_id), web_results with URLs

    Frontend->>Frontend: For each vector_result:
        If thread_id matches local thread:
            Display as deep link
        Else:
            Display as plain text

    Frontend->>Frontend: For each web_result:
        Display as clickable URL
```

---

## Summary

- The backend **persists** and **returns** thread IDs with vectors.
- The frontend **decides** which vectors to display as deep links.
- Web URLs are displayed inline.
- This separation keeps the backend simple and flexible.
